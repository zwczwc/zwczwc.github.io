<!DOCTYPE html><html lang="zh-CN" data-default-color-scheme="&#34;auto&#34;"><head><meta charset="UTF-8"><link rel="apple-touch-icon" sizes="76x76" href="/img/about.png"><link rel="icon" href="/img/about.png"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,shrink-to-fit=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta name="theme-color" content="#2f4154"><meta name="description" content=""><meta name="author" content="葱葱"><meta name="keywords" content=""><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome/css/font-awesome.min.css"><script src="/js/autoload.js"></script><title>微信红包抓包和原理分析 - CoolCC.top</title><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4.0.0/github-markdown.min.css"><link rel="stylesheet" href="/lib/hint/hint.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10.7.2/styles/github-gist.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_2604111_9w5dmb8rq8d.css"><script id="fluid-configs">var Fluid=window.Fluid||{},CONFIG={hostname:"example.com",root:"/",version:"1.8.11",typing:{enable:!0,typeSpeed:70,cursorChar:"_",loop:!1},anchorjs:{enable:!0,element:"h1,h2,h3,h4,h5,h6",placement:"right",visible:"hover",icon:""},progressbar:{enable:!0,height_px:3,color:"#29d",options:{showSpinner:!1,trickleSpeed:100}},copy_btn:!0,image_zoom:{enable:!0,img_url_replace:["",""]},toc:{enable:!0,headingSelector:"h1,h2,h3,h4,h5,h6",collapseDepth:0},lazyload:{enable:!0,loading_img:"/img/loading.gif",onlypost:!1,offset_factor:2},web_analytics:{enable:!0,baidu:null,google:null,gtag:null,tencent:{sid:null,cid:null},woyaola:null,cnzz:null,leancloud:{app_id:"0pn8PXbA3sKEuVH8KpP9X0A0-9Nh9j0Va",app_key:"UEkRIotTtFIsgmheXMFMWtvl",server_url:"https://0pn8pxba.lc-cn-e1-shared.com"}},search_path:"/local-search.xml"}</script><script src="/js/utils.js"></script><script src="/js/color-schema.js"></script><meta name="generator" content="Hexo 5.4.0"></head><body><header style="height:70vh"><nav id="navbar" class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar"><div class="container"><a class="navbar-brand" href="/">&nbsp;<strong>CoolCC</strong>&nbsp;</a> <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><div class="animated-icon"><span></span><span></span><span></span></div></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav ml-auto text-center"><li class="nav-item"><a class="nav-link" href="/"><i class="iconfont icon-home-fill"></i> 首页</a></li><li class="nav-item"><a class="nav-link" href="/archives/"><i class="iconfont icon-archive-fill"></i> 归档</a></li><li class="nav-item"><a class="nav-link" href="/categories/"><i class="iconfont icon-category-fill"></i> 分类</a></li><li class="nav-item"><a class="nav-link" href="/tags/"><i class="iconfont icon-tags-fill"></i> 标签</a></li><li class="nav-item"><a class="nav-link" href="/about/"><i class="iconfont icon-user-fill"></i> 关于</a></li><li class="nav-item" id="search-btn"><a class="nav-link" target="_self" data-toggle="modal" data-target="#modalSearch">&nbsp;<i class="iconfont icon-search"></i>&nbsp;</a></li><li class="nav-item" id="color-toggle-btn"><a class="nav-link" target="_self">&nbsp;<i class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a></li></ul></div></div></nav><div class="banner" id="banner" parallax="true" style="background:url(https://raw.githubusercontent.com/zwczwc/res/master/2018/wechatRedPacketAnalysis/index_img.png) no-repeat center center;background-size:cover"><div class="full-bg-img"><div class="mask flex-center" style="background-color:rgba(0,0,0,.3)"><div class="page-header text-center fade-in-up"><span class="h2" id="subtitle" title="微信红包抓包和原理分析"></span><div class="mt-3"><span class="post-meta"><i class="iconfont icon-date-fill" aria-hidden="true"></i> <time datetime="2018-06-12 00:00" pubdate>2018年6月12日 凌晨</time></span></div><div class="mt-1"><span class="post-meta mr-2"><i class="iconfont icon-chart"></i> 2k 字 </span><span class="post-meta mr-2"><i class="iconfont icon-clock-fill"></i> 19 分钟 </span><span id="busuanzi_container_page_pv" style="display:none"><i class="iconfont icon-eye" aria-hidden="true"></i> <span id="busuanzi_value_page_pv"></span> 次</span></div></div></div></div></div></header><main><div class="container-fluid nopadding-x"><div class="row nomargin-x"><div class="d-none d-lg-block col-lg-2"></div><div class="col-lg-8 nopadding-x-md"><div class="container nopadding-x-md" id="board-ctn"><div class="py-5" id="board"><article class="post-content mx-auto"><h1 style="display:none">微信红包抓包和原理分析</h1><div class="markdown-body"><h2 id="抓包方式"><a href="#抓包方式" class="headerlink" title="抓包方式"></a>抓包方式</h2><p>抓取微信红包数据包的工具是 <strong>Wireshark</strong>。Wireshark 的功能无需赘述了，最强大<br>的网络封包协议分析软件，没有之一。</p><p>另外还有手机型号系统和微信版本的问题，尝试过安卓系统手机和高版本的微信，只抓到两个微信红包数据包，难以进行分析，最后确定是在苹果系统和微信 6.5版本环境下才能抓到理想的数据包。</p><p>抓取微信红包数据包的方式就是笔记本电脑通过 WIFI 连接路由器上网，然后利用笔记本电脑网<br>卡的双频收发功能，连接 WIFI 的同时开启热点，手机WIFI 连接电脑开启的热点上网，最后在<br>Wireshark 中监听开启笔记本热点的网络连接即可。注意到 Wireshark 的抓包能力过强，抓到网络<br>协议的多层数据包，信息量巨大繁杂，因此要在过滤器工具栏中添加 http 协议的过滤规则，方便抓包。</p><h2 id="抓包分析"><a href="#抓包分析" class="headerlink" title="抓包分析"></a>抓包分析</h2><p>关于微信红包，一般是发红包，收红包和查看红包这三个流程。</p><p>发红包</p><p><img src="https://raw.githubusercontent.com/zwczwc/res/master/2018/wechatRedPacketAnalysis/sendRedPacket.png" srcset="/img/loading.gif" lazyload></p><p>收红包</p><p><img src="https://raw.githubusercontent.com/zwczwc/res/master/2018/wechatRedPacketAnalysis/receiveRedPacket.png" srcset="/img/loading.gif" lazyload></p><p>查看红包</p><p><img src="https://raw.githubusercontent.com/zwczwc/res/master/2018/wechatRedPacketAnalysis/queryRedPacket.png" srcset="/img/loading.gif" lazyload></p><p>每个数据包的Info一栏中的英文字段能直观地反应出这个数据包的作用，而高版本的微信再次巩固了安全性，对Info一栏进行了加密，变成复杂的英文数字组合。也可以看出<strong>红包的发起请求方法为POST</strong>，参数不会被保存，比起GET请求方法更加安全。在这些数据包中任意选中一个查看详情，发现主要交互域名为<strong>short.weixin.qq.com</strong>，实验时服务器的IP地址为同一个，为<strong>182.254.92.141</strong>。</p><p><img src="https://raw.githubusercontent.com/zwczwc/res/master/2018/wechatRedPacketAnalysis/mainDomain.png" srcset="/img/loading.gif" lazyload></p><p><img src="https://raw.githubusercontent.com/zwczwc/res/master/2018/wechatRedPacketAnalysis/sameIPAddress.png" srcset="/img/loading.gif" lazyload></p><h2 id="红包延迟"><a href="#红包延迟" class="headerlink" title="红包延迟"></a>红包延迟</h2><p>抢红包延迟可以分为<strong>网络传输延迟</strong>和<strong>用户终端延迟</strong>两类。</p><p>从数据包角度来看，网络传输延迟主要发生在收到红包和打开红包这两个会话的延迟，如下图时间所示，客户端点击收到的红包消息时请求服务器，直至收到服务器返回红包状态的响应，来回延迟大约为0.11s。客户端点击拆开红包时请求服务器，直至收到服务器返回红包已打开和金额详情的响应，来回延迟则大约为0.53s。可见拆开红包时涉及了红包金额分配算法运行和支付管理入账等安全操作，需要更多的时间，<strong>服务器回复客户端显然要比单纯回复红包是否被抢光的前一个请求慢得多。</strong></p><p><img src="https://raw.githubusercontent.com/zwczwc/res/master/2018/wechatRedPacketAnalysis/networkLatency.png" srcset="/img/loading.gif" lazyload></p><p>用户终端延迟则包括了<strong>用户操作延迟</strong>和<strong>用户终端UI延迟</strong>。用户操作延迟无可厚非就是看人的反应和点击速度快慢了，因人而异。用户终端UI延迟集中在屏幕的物理响应和UI绘制延迟，据网上资料显示，苹果手机凭借着优异的系统性能和屏幕响应机制，抢红包比安卓手机更占优势。</p><p><a target="_blank" rel="noopener" href="https://weibo.com/p/1001603814272596583142">参考</a></p><p>至于供应商流量环境和WIFI环境下的抢红包速度对比，一般而言，<strong>WIFI抢红包速度胜于流量</strong>。距离方面，无线传输距离越长，则耗费时间越长。WIFI环境下用户终端到路由器距离比流量环境下到基站距离短，减少了延迟，信号到达路由器或者基站后就能以有线光缆光速传输。设计标准方面，流量环境下的最佳技术LTE的目标时延为100ms，而WIFI在轻载之下可以达到10ms左右，速度相差了五倍。另外一个考虑因素是网络运营商建设，WIFI连接的有线网络运营商电信的骨干网建设优于流量运营商移动联通。腾讯的微信服务器和相关的红包服务器更有可能搭建在中国电信骨干网上。</p><h2 id="红包规律"><a href="#红包规律" class="headerlink" title="红包规律"></a>红包规律</h2><p>研究<strong>红包领取顺序与领取到的红包金额之间的关系</strong>。发红包设计方案如下：红包总额为20元，红包总数为20个，一共进行十轮红包发放，然后统计数据并分析，表格数据如下，黄色高亮为该轮最佳手气。</p><p><img src="https://raw.githubusercontent.com/zwczwc/res/master/2018/wechatRedPacketAnalysis/tableData.png" srcset="/img/loading.gif" lazyload></p><p><img src="https://raw.githubusercontent.com/zwczwc/res/master/2018/wechatRedPacketAnalysis/xychart.png" srcset="/img/loading.gif" lazyload></p><p>从散点图看出，绝大多数红包的金额大小<strong>分布在所有样本均值1附近</strong>。横坐标越大，纵坐标增大的概率越高，也就是说，最佳手气大多分布在领取顺序靠后的编号中，<strong>领取红包顺序越后，越容易领到最佳手气红包</strong>。因此，对于喜欢拼最佳手气的冒险主义者来说，不必见到红包就马上下手，静候片刻再拆开，或许能愿望成真，不过需要承担过于迟拆开导致红包被领光的风险。</p><p><img src="https://raw.githubusercontent.com/zwczwc/res/master/2018/wechatRedPacketAnalysis/meanLineChart.png" srcset="/img/loading.gif" lazyload></p><p>从均值折线图看出，均值随领取顺序变化波动较为剧烈，但总体还是<strong>围绕1上下波动变化的</strong>，也有可能是样本数据过少，个体偶然因素影响大，导致样本不够典型。因此，想利用上面“越后抢红包越容易拿最佳手气”这条规律的也不用沾沾自喜，白忙活一场抢红包大战下来，有可能抢到的跟别人的随缘抢也差不多，<strong>大家抢到的红包面额在概率上是大致均匀的</strong>。</p><p><img src="https://raw.githubusercontent.com/zwczwc/res/master/2018/wechatRedPacketAnalysis/stdLineChart.png" srcset="/img/loading.gif" lazyload></p><p>从标准差折线图看出，横坐标增大，纵坐标也增大，就是说<strong>标准差随着领取时间的增大而增大</strong>。标准差能够描述数据的离散程度，说明数据的稳定性，标准差越大，数据则波动得越剧烈。这也印证了前面的说法，往后容易领到大金额红包，为了把均值稳定在1附近，也容易领到小金额红包，因而这种极端值过多的情况使得标准差和方差增大。</p><p>总结，研究得到的微信红包规律性如下：<strong>微信红包是公平的，多次抢红包，领取到的金额是差不多的。每次领取顺序越前，领到的红包金额越是稳定在均值，领取顺序越后，领到的红包越是可能手气最佳或者手气最差。</strong></p><h2 id="红包算法"><a href="#红包算法" class="headerlink" title="红包算法"></a>红包算法</h2><p>根据资料，可认为微信红包满足的是<strong>截尾正态分布</strong>，算法即在截尾正态分布中取随机数，并用其求和数除以总价值，获得修正因子，再用修正因子乘上所有的随机数，得到红包价值。这种分布意味着：减少抽取红包大小分布的方差，让更多的人抽取的红包在均值附近，同时仍给一小部分人抽取大红包的机会，总体来说增加了红包抽取人的积极性和游戏的公平性。</p><p>并且为了防止最后领红包的人领时红包余额为0，红包机制可能为：当发红包者&lt;准备红包&gt;的时候，程序自动依照截尾分布产生了相应大小，相应个数的红包，然后随机发给抽取红包的人。同样，这样的一个随机过程有助于增加游戏的公平性，也减少了红包抽取人投机操作（亦即譬如故意等钱包半空的时候再抽取）的动机。 也即是说，不论先拿后拿，期望都是相同的。</p><p><a target="_blank" rel="noopener" href="http://coderroc.com/article/%E6%95%B0%E5%AD%A6%E5%92%8C%E7%AE%97%E6%B3%95/%E5%BE%AE%E4%BF%A1%E7%BA%A2%E5%8C%85%E9%9A%8F%E6%9C%BA%E7%AE%97%E6%B3%95%E5%88%9D%E6%8E%A2.html">参考</a></p></div><hr><div><div class="post-metas mb-3"></div><p class="note note-warning">本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！</p><div class="post-prevnext"><article class="post-prev col-6"><a href="/2018/07/10/%E5%88%A9%E7%94%A8%20DNS%20%E9%9A%A7%E9%81%93%E5%85%8D%E8%AE%A4%E8%AF%81%E4%B8%8A%E7%BD%91/"><i class="iconfont icon-arrowleft"></i> <span class="hidden-mobile">利用DNS隧道免认证上网</span> <span class="visible-mobile">上一篇</span></a></article><article class="post-next col-6"><a href="/2018/06/02/Github%20%E9%9D%99%E6%80%81%E9%A1%B5%E9%9D%A2%E8%87%AA%E5%AE%9A%E4%B9%89%E5%9F%9F%E5%90%8D%E5%BC%80%E5%90%AF%20Https/"><span class="hidden-mobile">Github静态页面自定义域名开启Https</span> <span class="visible-mobile">下一篇</span> <i class="iconfont icon-arrowright"></i></a></article></div></div><article class="comments" id="comments" lazyload><div id="valine"></div><script type="text/javascript">Fluid.utils.loadComments("#valine",(function(){Fluid.utils.createScript("https://cdn.jsdelivr.net/npm/valine@1.4.14/dist/Valine.min.js",(function(){var a=Object.assign({appId:"0pn8PXbA3sKEuVH8KpP9X0A0-9Nh9j0Va",appKey:"UEkRIotTtFIsgmheXMFMWtvl",placeholder:"说点什么...(昵称填Q号可以用QQ头像作评论头像 or 邮箱填Gravatar的邮箱)",path:"window.location.pathname",avatar:"retro",meta:["nick","mail","link"],pageSize:10,lang:"zh-CN",highlight:!1,recordIP:!1,serverURLs:"",emojiCDN:null,emojiMaps:null,enableQQ:!0,requiredFields:[]},{el:"#valine",path:window.location.pathname});new Valine(a)}))}))</script><noscript>Please enable JavaScript to view the comments</noscript></article></article></div></div></div><div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn"><div id="toc"><p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p><div class="toc-body" id="toc-body"></div></div></div></div></div><a id="scroll-top-button" href="#" role="button"><i class="iconfont icon-arrowup" aria-hidden="true"></i></a><div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable modal-lg" role="document"><div class="modal-content"><div class="modal-header text-center"><h4 class="modal-title w-100 font-weight-bold">搜索</h4><button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body mx-3"><div class="md-form mb-5"><input type="text" id="local-search-input" class="form-control validate"> <label data-error="x" data-success="v" for="local-search-input">关键词</label></div><div class="list-group" id="local-search-result"></div></div></div></div></div><div class="col-lg-7 mx-auto nopadding-x-md"><div class="container custom mx-auto"><div id="aplayer"></div><script type="text/javascript" src="/js/APlayer.min.js"></script><script type="text/javascript" src="/js/music.js"></script></div></div></main><footer class="text-center mt-5 py-3"><div class="footer-content"><span>Theme - </span><a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a></div><div class="statistics"><span id="leancloud-site-pv-container" style="display:none">总访问量 <span id="leancloud-site-pv"></span> 次 </span><span id="leancloud-site-uv-container" style="display:none">总访客数 <span id="leancloud-site-uv"></span> 人</span></div></footer><script src="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.css"><script>NProgress.configure({showSpinner:!1,trickleSpeed:100}),NProgress.start(),window.addEventListener("load",(function(){NProgress.done()}))</script><script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.min.js"></script><script src="/js/events.js"></script><script src="/js/plugins.js"></script><script src="/js/img-lazyload.js"></script><script src="https://cdn.jsdelivr.net/npm/tocbot@4.12.3/dist/tocbot.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/anchor-js@4.3.1/anchor.min.js"></script><script defer src="https://cdn.jsdelivr.net/npm/clipboard@2.0.8/dist/clipboard.min.js"></script><script src="/js/local-search.js"></script><script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script defer src="/js/leancloud.js"></script><script src="https://cdn.jsdelivr.net/npm/typed.js@2.0.12/lib/typed.min.js"></script><script>!function(t,i){(0,Fluid.plugins.typing)(i.getElementById("subtitle").title)}(window,document)</script><script src="/js/boot.js"></script></body></html>